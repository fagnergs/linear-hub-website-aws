name: Sync Secrets to Lambda

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Sync Secrets to Lambda
        run: |
          echo "üîÑ Syncing GitHub Secrets to Lambda..."
          echo ""
          
          aws lambda update-function-configuration \
            --function-name linear-hub-contact-api \
            --environment Variables="{\
              RESEND_API_KEY=${{ secrets.RESEND_API_KEY }},\
              SLACK_WEBHOOK_URL=${{ secrets.SLACK_WEBHOOK_URL }},\
              NOTION_API_KEY=${{ secrets.NOTION_API_KEY }},\
              NOTION_CONTACTS_DATABASE_ID=${{ secrets.NOTION_CONTACTS_DATABASE_ID }},\
              LINEAR_API_KEY=${{ secrets.LINEAR_API_KEY }}\
            }" \
            --query 'Environment.Variables' \
            --output json
          
          echo ""
          echo "‚úÖ Secrets synced to Lambda!"

      - name: Verify Lambda Configuration
        run: |
          echo "üìã Lambda Environment Variables:"
          echo ""
          
          aws lambda get-function-configuration \
            --function-name linear-hub-contact-api \
            --query 'Environment.Variables' \
            --output json | jq 'keys'
          
          echo ""
          echo "‚úÖ Verification complete"

      - name: Test Slack Integration
        if: success() && env.SLACK_WEBHOOK_URL != ''
        continue-on-error: true
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          echo "üß™ Testing Slack Webhook..."
          
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "‚ö†Ô∏è  Slack webhook not configured, skipping notification"
            exit 0
          fi
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H 'Content-type: application/json' \
            --data '{
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "‚úÖ *Lambda Secrets Synced Successfully*\n_Time: '$( date '+%d/%m/%Y %H:%M:%S' )'_"
                  }
                }
              ]
            }' \
            "$SLACK_WEBHOOK_URL")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          echo "Slack Response: $BODY (HTTP $HTTP_CODE)"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Slack webhook is working!"
          else
            echo "‚ö†Ô∏è  Slack response code: $HTTP_CODE"
          fi
